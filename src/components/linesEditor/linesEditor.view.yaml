elementName: rvn-lines-editor

handleBeforeMountviewDataSchema:
  type: object
  properties:
    selectedLineId:
      type: string
    mode:
      type: string

propsSchema:
  type: object
  properties:
    lines:
      type: array
      items:
        type: object
        properties:
    selectedLineId:
      type: string
    sectionLineChanges:
      type: object

refs:
  container:
    eventListeners:
      keydown:
        handler: handleContainerKeyDown
  line-*:
    eventListeners:
      focus:
        handler: handleOnFocus
      blur:
        handler: handleLineBlur
      input:
        handler: handleOnInput
      # mousedown:
      #   handler: handleBlockMouseDown
      mouseup:
        handler: handleLineMouseUp
      # beforeinput:
      #   handler: handleBlockBeforeInput
      # compositionend:
      #   handler: handleBlockCompositionEnd
      # compositionstart:
      #   handler: handleBlockCompositionStart
      keydown:
        handler: handleLineKeyDown
  preview-*:
    eventListeners:
      contextmenu:
        handler: handlePreviewRightClick

styles:
  'div[contenteditable]':
    font-size: 16px
    font-family: inherit
    line-height: 1.5
    word-break: break-word
  'div[contenteditable]:focus':
    outline: none
  'rvn-file-image':
    pointer-events: none
    user-select: none
    -webkit-user-drag: none

template:
  - $if ready:
      - 'rtgl-view#container w=f tabindex=0 style="outline: none;"':
          - $for line, i in lines:
              - 'rtgl-view d=h w=f style="background-color: ${line.backgroundColor};"':
                  - rtgl-view h=f w=32 ah=e mr=md pt=sm:
                      - rtgl-text s=sm c=${line.lineColor}: ${line.lineNumber}
                  - rtgl-view wh=24 br=f mr=md:
                      - $if line.characterFileId:
                          - rvn-file-image fileId=${line.characterFileId} w=24 h=24 br=f:
                  - rtgl-view d=h w=f:
                      - rtgl-view w=f:
                          - 'div#line-${line.id} style="width: 100%; padding-bottom: 4px;" contenteditable=plaintext-only': ${line.actions.dialogue.content[0].text}
                          - $if line.sectionTransition:
                              - rtgl-view#preview-sectionTransition data-type="sectionTransition" data-id="${line.id}" d=h:
                                  - rtgl-svg svg="transition" wh=16:
                                  - rtgl-svg svg="section" wh=16:
                                  - rtgl-text s=sm: "Transition to section: ${line.transitionTarget}"
                          - $if line.hasChoices:
                              - rtgl-view#preview-choice data-type="choice" data-id="${line.id}" d=v:
                                  - rtgl-view d=h:
                                      - rtgl-svg svg="choices" wh=16:
                                      - rtgl-text s=sm: "Choices:"
                                  - $for choice in line.choices:
                                      - rtgl-view d=h ml=sm:
                                          - rtgl-text s=sm: "â€¢ ${choice.content}"

                      - rtgl-view d=h:
                          - $if line.background:
                              - rtgl-view#preview-background data-type="background" data-id="${line.id}" pos=rel mr=sm:
                                  - $if line.background.fileId:
                                      - rvn-file-image w=36 h=24 fileId=${line.background.fileId}:
                                    $else:
                                      - rtgl-view w=36 h=24 av=c ah=c:
                                          - rtgl-svg svg=image wh=24:
                                  - $if line.background.changeType == "delete":
                                      - rtgl-view pos=abs cor=full bgc=danger av=c ah=c:
                                          - rtgl-svg svg=x wh=16 c=white:
                          - $if line.characterSprites:
                              - rtgl-view#preview-character data-type="character" data-id="${line.id}" pos=rel mr=sm:
                                  - $if line.characterSprites.items && line.characterSprites.items.length > 0:
                                      - rtgl-view d=h:
                                          - $for sprite in line.characterSprites.items:
                                              - rvn-file-image fileId=${sprite.fileId} w=20 h=24 br=f:
                                    $else:
                                      - rtgl-view w=36 h=24 av=c ah=c:
                                          - rtgl-svg svg=character wh=24:
                                  - $if line.characterSprites.changeType == "delete":
                                      - rtgl-view pos=abs cor=full bgc=danger av=c ah=c:
                                          - rtgl-svg svg=x wh=16 c=white:
                          - $if line.hasDialogueLayout:
                              - rtgl-view#preview-dialogue data-type="dialogue" data-id="${line.id}" pos=rel mr=sm w=36 h=24 av=c ah=c:
                                  - rtgl-svg svg="dialogue" wh=24:
                                  - $if line.dialogueChangeType == "delete":
                                      - rtgl-view pos=abs cor=full bgc=danger av=c ah=c:
                                          - rtgl-svg svg=x wh=16 c=white:
                          - $if line.hasBase:
                              - rtgl-view#preview-base data-type="base" data-id="${line.id}" pos=rel mr=sm w=36 h=24 av=c ah=c:
                                  - rtgl-svg svg="screen" wh=24:
                                  - $if line.baseChangeType == "delete":
                                      - rtgl-view pos=abs cor=full bgc=danger av=c ah=c:
                                          - rtgl-svg svg=x wh=16 c=white:
                          - $if line.bgm:
                              - rtgl-view#preview-bgm data-type="bgm" data-id="${line.id}" pos=rel mr=sm w=36 h=24 av=c ah=c:
                                  - rtgl-svg svg="music" wh=24:
                                  - $if line.bgm.changeType == "delete":
                                      - rtgl-view pos=abs cor=full bgc=danger av=c ah=c:
                                          - rtgl-svg svg=x wh=16 c=white:
                          - $if line.hasSfx:
                              - rtgl-view#preview-sfx data-type="sfx" data-id="${line.id}" pos=rel mr=sm w=36 h=24 av=c ah=c:
                                  - rtgl-svg svg="audio" wh=24:
                                  - $if line.sfxChangeType == "delete":
                                      - rtgl-view pos=abs cor=full bgc=danger av=c ah=c:
                                          - rtgl-svg svg=x wh=16 c=white:
                          - $if line.hasSetNextLineConfig:
                              - rtgl-view#preview-setNextLineConfig data-type="setNextLineConfig" data-id="${line.id}" pos=rel mr=sm w=36 h=24 av=c ah=c:
                                  - rtgl-svg svg="settings" wh=24:
                                  - $if line.setNextLineConfigChangeType == "delete":
                                      - rtgl-view pos=abs cor=full bgc=danger av=c ah=c:
                                          - rtgl-svg svg=x wh=16 c=white:
