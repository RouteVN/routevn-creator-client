elementName: rvn-scene-editor

viewDataSchema:
  type: object
  properties:
    currentLines:
      type: array
      items:
        type: object
        properties:
          id:
            type: string

refs:
  lines-editor:
    eventListeners:
      editor-data-changed:
        handler: handleEditorDataChanged
      newLine:
        handler: handleNewLine
      splitLine:
        handler: handleSplitLine
      moveUp:
        handler: handleMoveUp
      moveDown:
        handler: handleMoveDown
      mergeLines:
        handler: handleMergeLines
      lineSelectionChanged:
        handler: handleLineSelectionChanged
  presentation-action-*:
    eventListeners:
      click:
        handler: handleOpenCommandLine
      contextmenu:
        handler: handlePresentationActionRightClick
  section-tab-*:
    eventListeners:
      click:
        handler: handleSectionTabClick
      contextmenu:
        handler: handleSectionTabRightClick
  section-add:
    eventListeners:
      click:
        handler: handleSectionAddClick
  dropdown-menu:
    eventListeners:
      close:
        handler: handleDropdownMenuClickOverlay
      click-item:
        handler: handleDropdownMenuClickItem
  popover:
    eventListeners:
      close:
        handler: handlePopoverClickOverlay
  form:
    eventListeners:
      action-click:
        handler: handleFormActionClick
  add-presentation-button:
    eventListeners:
      click:
        handler: handleAddPresentationButtonClick
  command-line-*:
    eventListeners:
      back-to-actions:
        handler: handleBackToActions
      actionClicked:
        handler: handleActionClicked
      submit:
        handler: handleCommandLineSubmit
  toggle-sections-graph-view:
    eventListeners:
      click:
        handler: handleToggleSectionsGraphView
  actions-dialog:
    eventListeners:
      close:
        handler: handleActionsDialogClose

template:
  - rtgl-view w=f h=f:
      - rtgl-view bwb=xs w=f h=48 av=c ph=lg:
          - rtgl-text c=mu-fg: ${scene.name}
      - rtgl-view d=h w=f h=f:
          - $if sectionsGraphView:
              - 'rtgl-view w="calc((100vw - 64px) / 2)"':
                  - rtgl-view d=h w=f:
                      - rtgl-view flex=1:
                      # Toggle graph view button - commented out for now
                      # - rtgl-view#toggle-sections-graph-view h=32 av=c ph=lg ah=c bw=sm cur=p:
                      #     - rtgl-text s=sm: "<>"
                  - rtgl-view:
                      - rtgl-text: ${sectionsGraph}
            $else:
              - rtgl-view:
                  - 'rtgl-view d=h g=xs w="calc((100vw - 64px) / 2)" h=f':
                      - rtgl-view d=h sh:
                          - rtgl-view d=h g=xs:
                              - $for section in sections:
                                  - rtgl-view#section-tab-${section.id} w=120 h=32 av=c ph=lg ah=c bgc=${section.bgc} cur=p:
                                      - rtgl-text s=sm: ${section.name}
                      - rtgl-view#section-add h=32 av=c ph=lg ah=c cur=p bgc=mu:
                          - rtgl-text s=sm: +

                      - rtgl-view flex=1:
                      # Toggle graph view button - commented out for now
                      # - rtgl-view#toggle-sections-graph-view h=32 av=c ph=lg ah=c bw=sm cur=p:
                      #     - rtgl-text s=sm: "<>"
                  - 'rtgl-view w=f p=md h="calc(100vh - 48px - 32px - 2px)" sv':
                      - rvn-lines-editor#lines-editor .lines=currentLines .selectedLineId=selectedLineId:
                      - rtgl-view h=30vh:
          - rtgl-view w=1 h=f bgc=mu:
          - rtgl-view w=f:
              - rtgl-view:
                  - rtgl-view w=700 h=400 bgc=fg:
                      - 'div#canvas id=canvas style="width: 100%; height: 100%;display: flex;"':
              - rtgl-view w=f h=1 bgc=mu:
              - rtgl-view w=f m=md:
                  - rtgl-view d=h av=c:
                      - rtgl-text s=sm c=mu-fg: Actions
                  - rtgl-view g=md w=f pv=md:
                      - $for item in presentationData:
                          - $if item.type == "background":
                              - rtgl-view#${item.id} data-mode="${item.dataMode}" g=md d=h av=c ph=md bgc=mu br=md h-bgc=ac h=36 w=f cur=p:
                                  - rtgl-svg svg=${item.icon} wh=24:
                                  - rvn-file-image fileId=${item.data.backgroundImage.fileId} w=50 h=35:
                                  - rtgl-text s=sm: ${item.data.backgroundImage.name}
                            $elif item.type == "bgm":
                              - rtgl-view#${item.id} data-mode="${item.dataMode}" g=md d=h av=c ph=md bgc=mu h-bgc=ac br=md h=36 w=f cur=p:
                                  - rtgl-svg svg=${item.icon} wh=24:
                                  - rtgl-text s=sm: ${item.data.bgmAudio.name}
                            $elif item.type == "sfx":
                              - rtgl-view#${item.id} data-mode="${item.dataMode}" g=md d=h av=c ph=md bgc=mu h-bgc=ac br=md h=36 w=f cur=p:
                                  - rtgl-svg svg=${item.icon} wh=24:
                                  - rtgl-text s=sm: ${item.data.soundEffectsNames}
                            $elif item.type == "characters":
                              - rtgl-view#${item.id} data-mode="${item.dataMode}" g=md d=h av=c ph=md bgc=mu h-bgc=ac br=md h=36 w=f cur=p:
                                  - rtgl-svg svg=${item.icon} wh=24:
                                  - rtgl-view d=h g=sm av=c:
                                      - $for charData, i in item.data.charactersData:
                                          - $if charData.sprite && charData.sprite.fileId:
                                              - rvn-file-image fileId=${charData.sprite.fileId} w=35 h=35:
                                            $else:
                                              - rtgl-view w=35 h=35 bgc=ac av=c ah=c:
                                                  - rtgl-text s=xs: No Sprite
                            $elif item.type == "sectionTransition":
                              - rtgl-view#${item.id} data-mode="${item.dataMode}" g=md d=h av=c ph=md bgc=mu h-bgc=ac br=md h=36 w=f cur=p:
                                  - rtgl-svg svg="transition" wh=24:
                                  - rtgl-svg svg=${item.icon} wh=24:
                                  - $if item.data.sectionTransitionData.scene:
                                      - rtgl-text s=sm: "Transition to scene: ${item.data.sectionTransitionData.scene.name} section: ${item.data.sectionTransitionData.section.name}"
                                    $else:
                                      - rtgl-text s=sm: "Transition to section: ${item.data.sectionTransitionData.section.name}"
                            $elif item.type == "dialogue":
                              - $if item.data.dialogueCharacterData || item.data.dialogueData:
                                  - rtgl-view#${item.id} data-mode="${item.dataMode}" g=md d=h av=c ph=md bgc=mu h-bgc=ac br=md h=36 w=f cur=p:
                                      - rtgl-svg svg=${item.icon} wh=24:
                                      - $if item.data.dialogueData:
                                          - rtgl-text s=sm: ${item.data.dialogueData.name}
                                      - $if item.data.dialogueCharacterData:
                                          - rvn-file-image fileId=${item.data.dialogueCharacterData.fileId} w=32 h=32 br=f:
                            $elif item.type == "choices":
                              - rtgl-view#${item.id} data-mode="${item.dataMode}" g=md d=h av=c ph=md bgc=mu h-bgc=ac br=md h=36 w=f cur=p:
                                  - rtgl-svg svg=${item.icon} wh=24:
                                  - rtgl-view d=v:
                                      - rtgl-text s=sm: "Choices"
                                      - $for choice in item.data.choicesData.items:
                                          - rtgl-text s=xs c=mu-fg: "â€¢ ${choice.content}"
                      - rtgl-button#add-presentation-button w=f v=ol: Add Action
  - rtgl-dialog#actions-dialog ?open=${isActionsDialogOpen}:
      - rtgl-view slot=content w=800 h=80vh:
          - $if mode == "actions":
              - rvn-command-line-actions#command-line-actions:
            $elif mode == "dialogue":
              - rvn-command-line-dialogue-box#command-line-dialogue-box .layouts=layouts .characters=allCharacters .line=selectedLine:
            $elif mode == "choice":
              - rvn-command-line-choices#command-line-choices .layouts=layouts .line=selectedLine:
            $elif mode == "background":
              - rvn-command-line-background#command-line-background data-mode="background" .line=selectedLine:
            $elif mode == "bgm":
              - rvn-command-line-bgm#command-line-bgm .line=selectedLine:
            $elif mode == "sfx":
              - rvn-command-line-sound-effects#command-line-sound-effects .line=selectedLine:
            $elif mode == "character":
              - rvn-command-line-characters#command-line-characters .line=selectedLine .presentationState=presentationState:
            $elif mode == "sectionTransition":
              - rvn-command-line-section-transition#command-line-section-transition .line=selectedLine .sections=sections:
            $elif mode == "controls":
              - rvn-command-line-controls#command-line-controls .line=selectedLine:
            $elif mode == "conditional":
              - rvn-command-line-conditional#command-line-conditional:
  - rtgl-dropdown-menu#dropdown-menu .items=dropdownMenu.items x=${dropdownMenu.position.x} y=${dropdownMenu.position.y} ?open=${dropdownMenu.isOpen}:
  - rtgl-popover#popover ?open=${popover.isOpen} x=${popover.position.x} y=${popover.position.y}:
      - rtgl-form#form slot=content .form=form:
