<!DOCTYPE html>
<html>
<head>
    <title>Permissions Test</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .pass {
            color: green;
            font-weight: bold;
        }
        .fail {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <a href="/projects"><button>Back</button></a>
    <h1>Tauri Permissions Test</h1>

    <div>
        <input type="text" id="testPath" placeholder="Test project path">
        <label>
            <input type="checkbox" id="isAuthorizedPath"> This is an authorized path (granted via dialog)
        </label>
        <button onclick="runTests()">Run Tests</button>
    </div>

    <table id="resultsTable" style="display: none;">
        <thead>
            <tr>
                <th>Test passed</th>
                <th>Test case</th>
                <th>Failed reason</th>
            </tr>
        </thead>
        <tbody id="resultsBody">
        </tbody>
    </table>

    <script type="module">
        import { open } from '@tauri-apps/plugin-dialog';
        import { readDir, exists, writeFile, readFile } from '@tauri-apps/plugin-fs';
        import { join, appDataDir } from '@tauri-apps/api/path';
        import Database from '@tauri-apps/plugin-sql';

        async function selectDirectory() {
            return await open({
                directory: true,
                recursive: true
            });
        }

        async function runTests() {
            const resultsTable = document.getElementById('resultsTable');
            const resultsBody = document.getElementById('resultsBody');
            const pathInput = document.getElementById('testPath');
            const isAuthorizedCheckbox = document.getElementById('isAuthorizedPath');

            let testPath = pathInput.value;
            if (!testPath) {
                testPath = await selectDirectory();
                if (!testPath) {
                    return;
                }
                pathInput.value = testPath;
                // Auto-check authorized path if selected via dialog
                isAuthorizedCheckbox.checked = true;
            }

            const isAuthorized = isAuthorizedCheckbox.checked;
            resultsBody.innerHTML = '';

            const tests = [];

            // Test 1: Try to read .persistent-scope file from $APPDATA
            tests.push({
                name: 'fs.readFile("$APPDATA/.persistent-scope") should throw Unauthorized error',
                run: async () => {
                    const appDataPath = await appDataDir();
                    const persistentScopeFile = await join(appDataPath, '.persistent-scope');
                    const scopeExists = await exists(persistentScopeFile);
                    if (scopeExists) {
                        const content = await readFile(persistentScopeFile);
                        throw new Error('Read succeeded - should be forbidden');
                    } else {
                        throw new Error('File not found');
                    }
                }
            });

            // Test 2: Filesystem API readDir
            if (isAuthorized) {
                tests.push({
                    name: `fs.readDir("${testPath}") should succeed`,
                    run: async () => {
                        const entries = await readDir(testPath);
                        return entries;
                    }
                });
            } else {
                tests.push({
                    name: `fs.readDir("${testPath}") should throw Unauthorized error`,
                    run: async () => {
                        const entries = await readDir(testPath);
                        throw new Error('Read succeeded - should be forbidden');
                    }
                });
            }

            // Test 3: Filesystem API readDir subdirectory
            const testSubdir = await join(testPath, 'files');
            if (isAuthorized) {
                tests.push({
                    name: `fs.readDir("${testSubdir}") should succeed (recursive permission)`,
                    run: async () => {
                        const entries = await readDir(testSubdir);
                        return entries;
                    }
                });
            } else {
                tests.push({
                    name: `fs.readDir("${testSubdir}") should throw Unauthorized error`,
                    run: async () => {
                        const entries = await readDir(testSubdir);
                        throw new Error('Read succeeded - should be forbidden');
                    }
                });
            }

            // Test 4: Filesystem API writeFile
            const testFile = await join(testPath, 'files', 'test-permissions.txt');
            if (isAuthorized) {
                tests.push({
                    name: `fs.writeFile("${testFile}") should succeed`,
                    run: async () => {
                        await writeFile(testFile, new TextEncoder().encode('test'));
                        return 'Write succeeded';
                    }
                });
            } else {
                tests.push({
                    name: `fs.writeFile("${testFile}") should throw Unauthorized error`,
                    run: async () => {
                        await writeFile(testFile, new TextEncoder().encode('test'));
                        throw new Error('Write succeeded - should be forbidden');
                    }
                });
            }

            // Test 5: SQLite operations
            const dbPath = await join(testPath, 'test-permissions.db');
            if (isAuthorized) {
                tests.push({
                    name: `Database.load("sqlite:${dbPath}") should succeed`,
                    run: async () => {
                        const db = await Database.load(`sqlite:${dbPath}`);
                        await db.execute('CREATE TABLE IF NOT EXISTS test (id INTEGER PRIMARY KEY, name TEXT)');
                        await db.execute('INSERT INTO test (name) VALUES ("test")');
                        return 'SQLite operations succeeded';
                    }
                });
            } else {
                tests.push({
                    name: `Database.load("sqlite:${dbPath}") should throw Unauthorized error`,
                    run: async () => {
                        const db = await Database.load(`sqlite:${dbPath}`);
                        await db.execute('CREATE TABLE IF NOT EXISTS test (id INTEGER PRIMARY KEY, name TEXT)');
                        await db.execute('INSERT INTO test (name) VALUES ("test")');
                        throw new Error('SQLite operations succeeded - should be forbidden');
                    }
                });
            }

            // Run all tests
            for (const test of tests) {
                try {
                    await test.run();
                    resultsBody.innerHTML += `
                        <tr>
                            <td class="pass">✅ PASS</td>
                            <td>${test.name}</td>
                            <td></td>
                        </tr>
                    `;
                } catch (error) {
                    const errorMessage = error?.message || String(error);
                    // Special handling for Test 1 - file not found is expected
                    if (test.name.includes('.persistent-scope') && errorMessage.includes('File not found')) {
                        resultsBody.innerHTML += `
                            <tr>
                                <td class="pass">✅ PASS</td>
                                <td>${test.name}</td>
                                <td></td>
                            </tr>
                        `;
                    } else if (test.name.includes('should throw Unauthorized error') && !errorMessage.includes('should be forbidden')) {
                        // Any error means the operation was correctly blocked
                        resultsBody.innerHTML += `
                            <tr>
                                <td class="pass">✅ PASS</td>
                                <td>${test.name}</td>
                                <td></td>
                            </tr>
                        `;
                    } else {
                        resultsBody.innerHTML += `
                            <tr>
                                <td class="fail">❌ FAIL</td>
                                <td>${test.name}</td>
                                <td>${errorMessage}</td>
                            </tr>
                        `;
                    }
                }
            }

            resultsTable.style.display = 'table';
        }

        window.runTests = runTests;
    </script>
</body>
</html>
